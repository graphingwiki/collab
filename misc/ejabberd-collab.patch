diff -up ejabberd-2.1.6/src/extauth.erl.orig ejabberd-2.1.6/src/extauth.erl
--- ejabberd-2.1.6/src/extauth.erl.orig	2010-12-13 13:21:26.000000000 +0200
+++ ejabberd-2.1.6/src/extauth.erl	2011-01-31 15:25:01.000000000 +0200
@@ -35,7 +35,8 @@
 	 try_register/3,
 	 remove_user/2,
 	 remove_user/3,
-	 is_user_exists/2]).
+	 is_user_exists/2,
+     get_affiliation/4]).
 
 -include("ejabberd.hrl").
 
@@ -88,6 +89,9 @@ remove_user(User, Server) ->
 remove_user(User, Server, Password) ->
     call_port(Server, ["removeuser3", User, Server, Password]).
 
+get_affiliation(User, Server, Room, RoomServer) ->
+    call_port(?MYNAME, ["getaff", User, Server, Room, RoomServer]).
+
 call_port(Server, Msg) ->
     LServer = jlib:nameprep(Server),
     ProcessName = get_process_name(LServer, random_instance(get_instances(LServer))),
@@ -147,5 +151,7 @@ encode(L) ->
 decode([0,0]) ->
     false;
 decode([0,1]) ->
-    true.
+    true;
+decode(String) ->
+    list_to_atom(String).
 
diff -up ejabberd-2.1.6/src/mod_muc/mod_muc_room.erl.orig ejabberd-2.1.6/src/mod_muc/mod_muc_room.erl
--- ejabberd-2.1.6/src/mod_muc/mod_muc_room.erl.orig	2010-12-13 13:21:26.000000000 +0200
+++ ejabberd-2.1.6/src/mod_muc/mod_muc_room.erl	2011-01-31 15:38:24.000000000 +0200
@@ -1169,43 +1169,14 @@ set_affiliation_and_reason(JID, Affiliat
     StateData#state{affiliations = Affiliations}.
 
 get_affiliation(JID, StateData) ->
-    {_AccessRoute, _AccessCreate, AccessAdmin, _AccessPersistent} = StateData#state.access,
-    Res =
-	case acl:match_rule(StateData#state.server_host, AccessAdmin, JID) of
-	    allow ->
-		owner;
-	    _ ->
-		LJID = jlib:jid_tolower(JID),
-		case ?DICT:find(LJID, StateData#state.affiliations) of
-		    {ok, Affiliation} ->
-			Affiliation;
-		    _ ->
-			LJID1 = jlib:jid_remove_resource(LJID),
-			case ?DICT:find(LJID1, StateData#state.affiliations) of
-			    {ok, Affiliation} ->
-				Affiliation;
-			    _ ->
-				LJID2 = setelement(1, LJID, ""),
-				case ?DICT:find(LJID2, StateData#state.affiliations) of
-				    {ok, Affiliation} ->
-					Affiliation;
-				    _ ->
-					LJID3 = jlib:jid_remove_resource(LJID2),
-					case ?DICT:find(LJID3, StateData#state.affiliations) of
-					    {ok, Affiliation} ->
-						Affiliation;
-					    _ ->
-						none
-					end
-				end
-			end
-		end
-	end,
-    case Res of
-	{A, _Reason} ->
-	    A;
-	_ ->
-	    Res
+    {User, Server, _Resource} = jlib:jid_tolower(JID),
+    Room = StateData#state.room,
+    RoomServer = StateData#state.host,
+    case extauth:get_affiliation(User, Server, Room, RoomServer) of
+        false ->
+            none;
+        Affiliation -> 
+            Affiliation
     end.
 
 get_service_affiliation(JID, StateData) ->
diff -up ejabberd-2.1.6/src/mod_muc/mod_muc_room.hrl.orig ejabberd-2.1.6/src/mod_muc/mod_muc_room.hrl
--- ejabberd-2.1.6/src/mod_muc/mod_muc_room.hrl.orig	2010-12-13 13:21:26.000000000 +0200
+++ ejabberd-2.1.6/src/mod_muc/mod_muc_room.hrl	2011-01-31 15:25:01.000000000 +0200
@@ -38,8 +38,8 @@
 		 persistent = false,
 		 moderated = true,
 		 captcha_protected = false,
-		 members_by_default = true,
-		 members_only = false,
+		 members_by_default = false,
+		 members_only = true,
 		 allow_user_invites = false,
 		 password_protected = false,
 		 password = "",
diff -up ejabberd-2.1.6/src/web/ejabberd_http.erl.orig ejabberd-2.1.6/src/web/ejabberd_http.erl
--- ejabberd-2.1.6/src/web/ejabberd_http.erl.orig	2010-12-13 13:21:26.000000000 +0200
+++ ejabberd-2.1.6/src/web/ejabberd_http.erl	2011-01-31 15:25:01.000000000 +0200
@@ -770,7 +770,13 @@ parse_auth(_Orig = "Basic " ++ Auth64) -
 		    undefined;
 		SplitIndex ->
 		    {User, [$: | Pass]} = lists:split(SplitIndex-1, Auth),
-		    {User, Pass}
+            case string:tokens(User, "@") of
+            [Nick, Domain] -> 
+                NewUser = Nick ++ "%" ++ Domain;
+            _ ->
+                NewUser = User
+            end,
+            {NewUser ++ "@" ++ ?MYNAME, Pass}
 	    end
     end;
 parse_auth(_) ->
